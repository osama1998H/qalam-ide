name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      draft:
        description: 'Create as draft release'
        required: false
        default: true
        type: boolean
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Release version: $VERSION"

      - name: Validate version format
        run: |
          VERSION=${{ steps.version.outputs.version }}
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi
          echo "‚úÖ Version format is valid"

  build-mac:
    name: Build macOS
    runs-on: macos-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Update package.json version
        run: |
          VERSION=${{ needs.validate.outputs.version }}
          echo "Updating package.json version to $VERSION"
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Clean release directory
        run: rm -rf release/

      - name: Package for macOS
        run: npm run package:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # For future code signing:
          # CSC_LINK: ${{ secrets.MAC_CERTS }}
          # CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-mac
          path: release/
          retention-days: 1

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Update package.json version
        run: |
          $VERSION = "${{ needs.validate.outputs.version }}"
          Write-Host "Updating package.json version to $VERSION"
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Clean release directory
        run: Remove-Item -Recurse -Force release -ErrorAction SilentlyContinue

      - name: Package for Windows
        run: npm run package:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # For future code signing:
          # CSC_LINK: ${{ secrets.WIN_CERTS }}
          # CSC_KEY_PASSWORD: ${{ secrets.WIN_CERTS_PASSWORD }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: release/
          retention-days: 1

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Update package.json version
        run: |
          VERSION=${{ needs.validate.outputs.version }}
          echo "Updating package.json version to $VERSION"
          npm version $VERSION --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Clean release directory
        run: rm -rf release/

      - name: Package for Linux
        run: npm run package:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: release/
          retention-days: 1

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build-mac, build-windows, build-linux]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          VERSION=${{ needs.validate.outputs.version }}

          echo "üì¶ Preparing release assets for version $VERSION"
          echo ""

          # Find and copy all release files
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) | while read file; do
            filename=$(basename "$file")
            echo "  ‚Üí $filename"
            cp "$file" "release-assets/"
          done

          echo ""
          echo "üìÅ Release assets:"
          ls -la release-assets/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ needs.validate.outputs.version }}

          cat << 'EOF' > release-notes.md
          ## Qalam IDE v${{ needs.validate.outputs.version }}

          ### Installation

          #### macOS
          - **DMG Installer**: Download the `.dmg` file, open it, and drag Qalam IDE to Applications
          - **ZIP Archive**: Download and extract the `.zip` file

          #### Windows
          - **Installer**: Download and run the `.exe` installer
          - **Portable**: Download the portable `.exe` for no-install usage

          #### Linux
          - **AppImage**: Download, make executable (`chmod +x`), and run
          - **DEB Package**: Install with `sudo dpkg -i <file>.deb`
          - **RPM Package**: Install with `sudo rpm -i <file>.rpm` or `sudo dnf install <file>.rpm`

          ### Requirements
          - [Tarqeem Compiler](https://github.com/osama1998H/tarqeem) must be installed and available in PATH

          ### What's New
          See the [commit history](https://github.com/${{ github.repository }}/commits/v${{ needs.validate.outputs.version }}) for detailed changes.
          EOF

          echo "Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'push' && github.ref_name || format('v{0}', needs.validate.outputs.version) }}
          name: Qalam IDE v${{ needs.validate.outputs.version }}
          body_path: release-notes.md
          draft: ${{ github.event.inputs.draft == 'true' || github.event_name == 'push' }}
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: release-assets/*
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## üéâ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Assets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -1 release-assets/ | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done
